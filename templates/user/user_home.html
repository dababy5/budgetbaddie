{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="manifest" href="site.webmanifest" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.9"></script>
    <link rel="stylesheet" href="{% static 'dashboard.css' %}">
</head>
    <body>

        <nav class="navbar">
            <div class="logo"><a href="{% url 'index' %}">Budget Baddie</a></div>
            <ul class="nav-links">
            <!-- use this for navbar routing links -->
            </ul>
        </nav>
        <div class="dashboard-container">

            <!-- Header -->
            <header>
            <h1>Hey {{user.username}}</h1>
            </header>

            <!-- Weekly Budget Input -->
            <section class="budget-input">
            <h2>Make Your BudgetBaddie</h2>
                <a href="{% url 'budget_plan' %}" class="btn">Start</a>

            </section>

            <!-- Insights and AI Tips -->

            <div class="card chart">
  <h3>Spending Insights</h3>
                <form id="dateRangeForm">
    <label for="start">From:</label>
    <input type="date" id="start" name="start" required>
    <label for="end">To:</label>
    <input type="date" id="end" name="end" required>
    <button type="submit">Show</button>
  </form>

  <canvas id="spendingChart"></canvas>
            </div>
            <!-- AI Tips -->
            <div class="plans-container">
  <h2>Your Budget Plans</h2>

  {% if plans %}
    <table class="plans-table">
      <thead>
        <tr>
          <th>Plan Name</th>
          <th>Type</th>
          <th>Amount ($)</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>SMS Alerts</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody>
    {% for plan in plans %}
      <tr id="plan-{{ plan.id }}">
        <td>{{ plan.plan_name }}</td>
        <td>{{ plan.get_budget_type_display }}</td>
        <td>{{ plan.budget_amount }}</td>
        <td>{{ plan.start_date|default:"‚Äî" }}</td>
        <td>{{ plan.end_date|default:"‚Äî" }}</td>
        <td>
          {% if plan.accept_sms %}
            <span class="sms-badge enabled">Enabled</span>
          {% else %}
            <span class="sms-badge disabled">Disabled</span>
          {% endif %}
        </td>
        <td>
          <button 
            hx-post="{% url 'delete_budget_plan' plan.id %}" 
            hx-target="#plan-{{ plan.id }}" 
            hx-swap="outerHTML remove" 
            class="delete-btn"
            hx-on="htmx:beforeRequest: this.closest('tr').remove()"
          >
            üóëÔ∏è
          </button>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>
  {% else %}
    <p>No budget plans yet. <a href="{% url 'budget_plan' %}">Create one</a>.</p>
  {% endif %}
</div>

            </section>

            <!-- Chat Section -->
        <section class="chat">
            <div class="chat-box" id="chatBox">
                <!-- Responses will be injected here -->
            </div>

            <form 
                class="chat-input"
                method="POST"
                action="{% url 'gemini_process_purchases' %}"
                hx-post="{% url 'gemini_process_purchases' %}"
                hx-target="#chatBox"
                hx-swap="beforeend">
                
                {% csrf_token %}
                <input type="text" name="message" placeholder="Ask Budget Baddie for advice..." required>
                <button type="submit">Send</button>
            </form>
        </section>

</section>


        </div>

        <!-- Chart.js for graphs -->
         <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('spendingChart').getContext('2d');
  let chart;

  // Function to render chart
  function renderChart(chartData, labelText = "All Spending") {
    if (chart) chart.destroy(); // reset old chart

    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: chartData.labels,
        datasets: [{
          label: labelText,
          data: chartData.data,
          borderColor: '#7B5CF0',
          backgroundColor: 'rgba(123, 92, 240, 0.1)',
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: "Amount ($)" }
          },
          x: {
            title: { display: true, text: "Date" }
          }
        }
      }
    });
  }

  // Load chart data (with optional date filters)
  function loadChart(start = null, end = null) {
    let url = "{% url 'spending_chart_data' %}";
    if (start && end) {
      url += `?start=${start}&end=${end}`;
    }

    fetch(url)
      .then(response => response.json())
      .then(chartData => {
        let labelText = (start && end) ? `Spending from ${start} to ${end}` : "All Spending";
        renderChart(chartData, labelText);
      });
  }

  // Hook up form submission
  document.getElementById("dateRangeForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const start = document.getElementById("start").value;
    const end = document.getElementById("end").value;
    loadChart(start, end);
  });

  // Load all data on first page load
  loadChart();
</script>

    </body>
</html>